@page "/bucket_game"

<p>
    <button @onclick="bucketMoveAsync">Bucket</button> 
    <button @onclick="playerMoveAsync">Player</button> 
    <button @onclick="stop">Stop</button>
</p>

<div id="myGameArea">
    <div id ="myBucket" style=@bucketStyle></div>
    @if(players.Count > 0) {
        @foreach(var player in players)
        {
            <div id="myPlayer" style=@player.PlayerStyle></div>
        }
    }

</div>

@code {
    int bucketPos {get; set;}
    int increment {get; set;}
    int timer {get; set;}
    string bucketStyle {get; set;}
    bool decreasing {get; set;}
    bool running {get; set;}
    List<PlayerStuff> players {get; set;}

    protected override async Task OnInitializedAsync()
    {
        timer = 600;
        increment = 5;
        bucketPos = 0;
        bucketStyle = "bottom: 0; left: 0;";
        players = new List<PlayerStuff>();
        await Task.Delay(0);
    }
    public async Task bucketMoveAsync() {
        running = true;
        var i = 0;
        for (i=0; i <= timer; i++)
        {
            if(!running) 
            {
                break;
            }
            bucketStyle = string.Empty;
            bucketPos = calculateBucketMove(bucketPos);
            bucketStyle = "bottom: 0; left: " + bucketPos + "px;";
            StateHasChanged();
            await Task.Delay(30);
        }
    }
    public async Task playerMoveAsync() {
        PlayerStuff myPlayer = new PlayerStuff();
        players.Add(myPlayer);
        var i = 0;
        for (i=0; i <= timer; i++)
        {
            if(!myPlayer.PlayerFalling || !running) 
            {
                break;
            }
            if (players.Count > 0) {
                checkCollision(myPlayer);
            }
            myPlayer.PlayerStyle = string.Empty;
            calculatePlayerMove(myPlayer);
            myPlayer.PlayerStyle = "top: " + myPlayer.POSY + "px; left: " + myPlayer.POSX + "px;";
            StateHasChanged();
            await Task.Delay(30);
        }
    }
    private void calculatePlayerMove(PlayerStuff myPlayer) {
        myPlayer.POSY = myPlayer.POSY + (myPlayer.Speed / 2);

        if (!myPlayer.PlayerFallingForward)
        {
            myPlayer.POSX = myPlayer.POSX - myPlayer.Speed;
        } 
        else
        {
            myPlayer.POSX = myPlayer.POSX + myPlayer.Speed;
        }
        if (myPlayer.POSX <= 0)
        {
            myPlayer.PlayerFallingForward = true;

        } 
        else if (myPlayer.POSX >= 375)
        {
            myPlayer.PlayerFallingForward = false;
        }
        if (myPlayer.POSY >= 375)
        {
            myPlayer.PlayerFalling = false;
        }
    }

    private int calculateBucketMove(int startingPOS) {
        if(startingPOS >= 350 && !decreasing) 
        {
            decreasing = true;
        }
        else if (startingPOS <= 0 && decreasing) 
        {
            decreasing = false;
        }
        if (decreasing) {
            return startingPOS - increment;
        }
        return startingPOS + increment;
    }
    private void stop() {
        running = false;
        players = new List<PlayerStuff>();
    }

    private void checkCollision(PlayerStuff myPlayer) {
        var i = 0;
        for(i=0; i <= 50; i++) 
        {
            if (myPlayer.POSY + 25 >= 375 && myPlayer.POSY + 25 <= 380) 
            {
                if (myPlayer.POSX + 13 == bucketPos + i)
                {
                    running = false;
                } 
            }
        }
    }

    public class PlayerStuff
    {
        public int POSX {get; set;}
        public int POSY {get; set;}
        public int Speed {get; set;}
        public bool PlayerFalling {get; set;}
        public bool PlayerFallingForward {get; set;}
        public string PlayerStyle {get; set;}

        public PlayerStuff()
        {
            Random random = new Random();
            POSX = random.Next(0, 375);
            POSY = 0;
            Speed = random.Next(3,10);
            PlayerFalling = true;
            PlayerFallingForward = true;
            PlayerStyle = "top: 0; left: " + POSX;
        }
    }
}